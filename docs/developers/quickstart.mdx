---
sidebar_position: 2
---

# Quickstart

## PrÃ©requis

Avant de commencer, il est nÃ©cessaire dâ€™installer les outils de la [dev stack](/docs/developers/tools/stack) et de maÃ®triser les concepts piur les dÃ©veloppeurs.

# DÃ©velopper des services owl en local

:::info
ğŸ’¡ Pour ce How To, nous allons prendre lâ€™exemple du service https://github.com/owlgrid/owl-workflow.
:::

Pour dÃ©velopper en local, nous allons utiliser 3 Ã©lÃ©ments :

- Le repository model-interfaces qui comporte la description des services et de leurs opÃ©rations https://github.com/owlgrid/dev-model-interfacesÂ ;
- Le code source du service Ã  dÃ©velopper https://github.com/owlgrid/owl-workflow ;
- Le serveur local https://github.com/owlgrid/ops-mutualizedServer qui permet dâ€™exÃ©cuter le serviceÂ ;
- Le repository https://github.com/owlgrid/ops-test qui contient des jeux de test end-to-end permettant de contrÃ´ler le bon fonctionnement et Ã©ventuellement dâ€™identifier des rÃ©gressions.

## Mettre en place lâ€™environnement de travail

Pour commencer, cloner en local les repositories suivantsÂ :

- https://github.com/owlgrid/dev-model-interfaces
- https://github.com/owlgrid/ops-mutualizedServer
- https://github.com/owlgrid/owl-workflow, https://github.com/owlgrid/owl-access, https://github.com/owlgrid/owl-database, https://github.com/owlgrid/owl-manager, https://github.com/owlgrid/owl-organization, https://github.com/owlgrid/owl-perimeter, https://github.com/owlgrid/owl-template, https://github.com/owlgrid/owl-workspace

:::info
â“ WTF Jamy, pourquoi je dois cloner tous ces services ?
Parce que https://github.com/owlgrid/dev-model-interfaces exporte des spÃ©cifications (resourcesTree, stubs, types) dans tous les services Ã  **chaque exÃ©cution** Câ€™est mal foutu, mais il est prÃ©vu de pouvoir exporter les interfaces uniquement dans un service.
:::

## Ajouter / modifier des opÃ©rations dans owl-workflow

Les interfaces des opÃ©rations et leurs types sont dÃ©finies dans le repository dev-model-interfaces. Pour crÃ©er une nouvelle opÃ©ration, par exemple `listWorkflows`, il faut :

- AccÃ©der au dossier local `dev-model-interfaces`Â ;
- AccÃ©der au dossier `/resources/owl-workflow/operations`Â ;
- CrÃ©er un nouveau fichier avec le nom de lâ€™opÃ©ration `listWorkflows`Â ;

:::info ğŸ˜ Astuce de pro
Pour gagner du temps lors de lâ€™Ã©criture dâ€™une nouvelle opÃ©ration, copie un fichier dÃ©jÃ  existant avec une action similaire (ex : pour crÃ©er listWorkflows, je peux rÃ©cupÃ©rer lâ€™opÃ©ration listWorkspaces qui est relativement similaire, puis remplacer les valeurs pour sâ€™adapter Ã  mon opÃ©ration).
:::

- Si nÃ©cessaire, crÃ©er les fichiers de dÃ©finition des input et des outputs dans le dossier `/resources/owl-workflow/definitions`. Parfois, certains inputs ou outputs sont gÃ©nÃ©riques. Câ€™est notamment le cas de lâ€™input de lâ€™opÃ©ration de list (consulter les opÃ©rations similaires pour bien comprendre)Â ;
- Pour exporter lâ€™opÃ©ration vers le dossier owl-workflow, exÃ©cuter `yarn dev` dans `dev-model-interfaces` ;
- Se rendre dans le dossier local `owl-workflow` ;
- Dans le fichier `/src/controllers/listWorkflows`, implÃ©menter le code source de lâ€™opÃ©ration. Les types dâ€™entrÃ©e et de sortie de lâ€™opÃ©ration sont dÃ©jÃ  remplis.

## ExÃ©cuter le service

Pour exÃ©cuter le service owl-workflow, rends-toi dans le dossier `ops-mutualizedServer`, puis :

- Dans le fichier `src/binder.ts`, remplacer lâ€™import du package `import { generateMutualizedInterfaces as generateMutualizedInterfacesOWF } from "@owlgrid-dev/owl-workflow/lib/interfaces";`  par lâ€™import local : `import { generateMutualizedInterfaces as generateMutualizedInterfacesOWF } from "../../owl-manager/src/interfaces";`.
- Lance le serveur en exÃ©cutant `yarn dev`.

Pour que les modifications du code de owl-workflow soient prises en compte dans le serveur, il est nÃ©cessaire dâ€™exÃ©cuter la commande `rs` dans la console dâ€™ops-mutualizedServer, afin de le relancer avec les derniÃ¨res modifications de code.

## Tester

### Tests unitaires

Le service expose une API HTTP qui peut Ãªtre appelÃ©e via nâ€™importe quel client HTTP. La liste des routes exposÃ©es est affichÃ©e dans la console de ops-mutualizedServer au moment de son exÃ©cution. Pour faciliter les dÃ©veloppements, il est fortement recommandÃ© dâ€™ajouter chaque nouvelle route dans le workspace Postman dâ€™OwlGrid. Cela permet une meilleure gestion des environnements, historiques de requÃªtes et une authentification unifiÃ©e.

Plus dâ€™informations sur Postman : [RequÃªter lâ€™API](https://www.notion.so/Requ-ter-l-API-db7850adc4524f8185cae5608f384265).

### Tests end-to-end

Avant de dÃ©ployer le service, il est **impÃ©ratif** dâ€™Ã©crire des tests end-to-end. Ces tests permettent de vÃ©rifier que le comportement effectif est bien le comportement attendu, non seulement lors du dÃ©veloppement du service, mais surtout lors de dÃ©ploiements futurs afin dâ€™identifier des rÃ©gressions. Les tests doivent Ãªtre Ã©crits dans le repository https://github.com/owlgrid/ops-test dans le dossier `owl-[nom du service]`. Pour plus dâ€™informations sur le fonctionnement dâ€™ops-test, se rÃ©fÃ©rer au README du repository.

## DÃ©ployer le service

- Tester avec ops-test.
- Publier le module owl-workflow en exÃ©cutant la commande `yarn release`. Attention, le dÃ©veloppeur doit Ãªtre connectÃ© Ã  npm et utiliser un compte autorisÃ© Ã  publier dans lâ€™organisation owlgrid-dev : [https://www.npmjs.com/settings/owlgrid-dev/packages](https://www.npmjs.com/settings/owlgrid-dev/packages)
    - Avant exÃ©cution, run :
    
    ```bash
    yarn config set version-git-tag true
    ```
    
- Dans ops-mutualizedServer :
    - Dans le fichier `src/binder.ts`, remplacer lâ€™import local `import { generateMutualizedInterfaces as generateMutualizedInterfacesOWF } from "../../owl-manager/src/interfaces";` par lâ€™import du package `import { generateMutualizedInterfaces as generateMutualizedInterfacesOWF } from "@owlgrid-dev/owl-workflow/lib/interfaces";`.
    - Dans le fichier `/package.json`, mettre Ã  jour la dÃ©pendance `"@owlgrid-dev/owl-workflow": "^0.0.3",` sur la derniÃ¨re version publiÃ©e.
    - Installer la derniÃ¨re version du package en exÃ©cutant `yarn`.
- Tester les derniÃ¨res modifications en lanÃ§ant le serveur (`yarn dev`) puis en exÃ©cutant les tests end-to-end (dans ops-test, exÃ©cuter `yarn test`).
- Si tous les tests fonctionnent, pousser les modifications sur la branche `dev` de ops-mutualizedServer, puis crÃ©er une PR de `dev` vers `beta`. Si la PR est autorisÃ©e, valider. Le dÃ©ploiement du serveur est automatique (la progression peut Ãªtre suivie dans AWS â†’ CodePipeline â†’ owl-services-beta).
- Une fois que le service est dÃ©ployÃ©, vÃ©rifier quâ€™il sâ€™exÃ©cute correctement en exÃ©cutant les tests end-to-end sur lâ€™environnement distant (dans le fichier `.env`, remplacer la valeur de `mutualizedServersURL` par [`https://beta.app.owlgrid.com`](https://beta.app.owlgrid.com/)).
- Bravo ! Encore une affaire rondement menÃ©e ğŸ‰